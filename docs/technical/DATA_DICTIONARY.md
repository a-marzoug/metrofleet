# Metrofleet Data Dictionary

## Overview

This document defines the core data models used across the Metrofleet platform, including the Data Warehouse marts and application databases.

---

## Data Warehouse (dbt Marts)

### `dm_daily_revenue`

The primary source for the Executive Dashboard. Aggregates financial performance by day and borough.

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| `revenue_date` | Date | Trip pickup date | `2025-12-01` |
| `pickup_borough` | String | NYC Borough name | `Manhattan` |
| `total_trips` | Int | Count of valid trips | `15,234` |
| `total_revenue` | Float | Sum of `total_amount` | `$425,678.50` |
| `avg_ticket_size` | Float | Revenue per trip | `$27.95` |

**Used By:** Streamlit Dashboard, MetroAnalyst

---

### `fct_trips`

The central fact table for trip analysis and ML model training. Enriched with weather and holiday data.

| Column | Type | Description | Source |
|--------|------|-------------|--------|
| `trip_id` | UUID | Unique trip identifier | Generated |
| `pickup_datetime` | Timestamp | Trip start time | TLC |
| `dropoff_datetime` | Timestamp | Trip end time | TLC |
| `pickup_location_id` | Int | TLC Taxi Zone ID | TLC |
| `dropoff_location_id` | Int | TLC Taxi Zone ID | TLC |
| `trip_distance` | Float | Distance in miles | TLC |
| `total_amount` | Float | Final fare + surcharges + tips | TLC |
| `precip_mm` | Float | Precipitation at pickup hour | **Open-Meteo** |
| `temp_c` | Float | Temperature (Â°C) at pickup hour | **Open-Meteo** |
| `is_holiday` | Boolean | Is pickup date a holiday? | **Holidays Lib** |
| `holiday_name` | String | Holiday name or "Non-Holiday" | **Holidays Lib** |
| `pickup_hour` | Int | Hour of pickup (0-23) | Derived |
| `pickup_day_of_week` | Int | Day of week (0=Mon, 6=Sun) | Derived |

**Used By:** ML Training Pipeline, MetroAnalyst

---

---

## Predictive Data (Outputs)

### `demand_forecasts`

Generated by the Prophet pipeline. Contains hourly trip volume predictions.

| Column | Type | Description |
|--------|------|-------------|
| `forecast_timestamp` | Timestamp | The future hour being predicted. |
| `pickup_borough` | String | NYC Borough (e.g., Manhattan). |
| `predicted_demand` | Float | The forecasted number of trips (`yhat`). |
| `conf_lower` | Float | 95% Confidence Interval Lower Bound. |
| `conf_upper` | Float | 95% Confidence Interval Upper Bound. |

### `compliance_flags`

Generated by the Anomaly Detection job. Contains suspicious trips.

| Column | Type | Description |
|--------|------|-------------|
| `vendor_id` | Int | Taxi Vendor ID. |
| `pickup_datetime` | Timestamp | Trip time. |
| `score` | Int | `-1` = Anomaly, `1` = Normal. |
| `rule_id` | String | Model version that flagged it (e.g., "IsolationForest_v1"). |

---

## Raw Data (Source Layer)

### `raw_yellow_trips`

Direct ingestion from NYC TLC Parquet files.

| Attribute | Value |
|-----------|-------|
| **Partition Strategy** | Monthly (`YYYY-MM`) |
| **Update Frequency** | Monthly (historical) or Daily (simulated) |
| **Volume** | ~3-4 million rows per month |
| **Source** | NYC Taxi & Limousine Commission |

### `raw_weather`

Hourly weather data from the Open-Meteo Archive API.

| Attribute | Value |
|-----------|-------|
| **Partition Strategy** | Monthly |
| **Granularity** | Hourly |
| **Location** | NYC Central Park (40.7831, -73.9712) |
| **Fields** | Temperature, Precipitation, Wind Speed |

### `raw_holidays`

Reference table generated via the Python `holidays` library.

| Attribute | Value |
|-----------|-------|
| **Update Frequency** | Full Refresh (Ad-hoc) |
| **Scope** | US Federal + NY State Holidays |
| **Range** | 2023-2027 |

---

## Application Database (NeonDB)

### `trips` (Trip History)

Stores user fare predictions for the MetroHail consumer app.

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `pickup_zone_id` | Int | TLC Zone ID |
| `dropoff_zone_id` | Int | TLC Zone ID |
| `pickup_zone_name` | String | Human-readable zone name |
| `dropoff_zone_name` | String | Human-readable zone name |
| `pickup_datetime` | Timestamp | Requested pickup time |
| `trip_distance` | Float | Estimated distance (miles) |
| `estimated_fare` | Float | Predicted fare (USD) |
| `created_at` | Timestamp | Record creation time |

**ORM:** Drizzle ORM  
**Used By:** MetroHail `/api/trips`, Trip History UI

---

## Data Quality Rules

Enforced via dbt tests:

| Rule | Table | Condition |
|------|-------|-----------|
| **Fare Floor** | `fct_trips` | `total_amount > 0` |
| **Distance Floor** | `fct_trips` | `trip_distance > 0` |
| **Zone Integrity** | `fct_trips` | All `location_id` values map to valid zones |
| **Not Null** | All | Key columns are not null |
| **Unique** | `fct_trips` | No duplicate trip IDs |
