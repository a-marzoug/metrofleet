# API Specifications

## Overview

The Metrofleet platform exposes multiple APIs for different use cases:

| API | Base URL | Purpose |
|-----|----------|---------|
| Prediction API | `http://localhost:8000` | ML model inference |
| MetroHail BFF | `http://localhost:3001/api` | Consumer app backend |
| MetroAnalyst | `http://localhost:3002/api` | Conversational analytics |

---

## Prediction API (FastAPI)

**Base URL:** `http://localhost:8000`  
**Docs URL:** `http://localhost:8000/docs` (Swagger UI)

### Health Check

```http
GET /health
```

Returns service status and whether the model is loaded.

**Response:**

```json
{
  "status": "healthy",
  "model_loaded": true
}
```

---

### Predict Fare

```http
POST /predict/fare
```

Returns an estimated fare based on trip parameters.

**Request Body:**

| Field | Type | Required | Description | Example |
|-------|------|----------|-------------|---------|
| `pickup_location_id` | int | ✅ | TLC Taxi Zone ID | `132` (JFK) |
| `dropoff_location_id` | int | ✅ | TLC Taxi Zone ID | `230` (Times Sq) |
| `pickup_datetime` | datetime | ✅ | ISO 8601 format | `2025-12-05T14:30:00` |
| `trip_distance` | float | ✅ | Distance in miles | `10.5` |

**Example Request:**

```json
{
  "pickup_location_id": 132,
  "dropoff_location_id": 230,
  "pickup_datetime": "2025-12-05T14:30:00",
  "trip_distance": 10.5
}
```

**Success Response (200):**

```json
{
  "estimated_fare": 45.50,
  "currency": "USD",
  "model_version": "v1"
}
```

**Error Codes:**

| Code | Description |
|------|-------------|
| `422` | Validation Error (missing/invalid fields) |
| `503` | Model not loaded (API starting up or file missing) |

---

## MetroHail BFF Routes (Next.js)

**Base URL:** `http://localhost:3001`

### Predict (with History Save)

```http
POST /api/predict
```

Proxies to the Prediction API and saves the trip to user history.

**Request Body:** Same as `/predict/fare`

**Response:** Prediction result plus trip ID for history reference.

---

### Trip History

```http
GET /api/trips
```

Returns the user's previous fare predictions.

**Response:**

```json
{
  "trips": [
    {
      "id": "uuid",
      "pickup_zone": "JFK Airport",
      "dropoff_zone": "Times Square",
      "estimated_fare": 45.50,
      "created_at": "2025-12-05T14:30:00Z"
    }
  ]
}
```

---

### Delete Trip

```http
DELETE /api/trips/[id]
```

Removes a trip from user history.

---

## MetroAnalyst Chat API

**Base URL:** `http://localhost:3002`

### Chat (Streaming)

```http
POST /api/chat
```

Streams a chat response generated by the LLM with access to the data warehouse.

**Request Body:**

```json
{
  "messages": [
    { "role": "user", "content": "What was the total revenue in Manhattan last week?" }
  ]
}
```

**Response:** Streaming UI message payload (compatible with `@ai-sdk/react`).

**Behavior:**

- The route applies a **system prompt** instructing the assistant to prefer data warehouse queries
- Exposes a **read-only SQL tool** (`runQuery`) to the model
- **Safety controls:**
  - Blocked keywords: `INSERT`, `UPDATE`, `DELETE`, `DROP`, `ALTER`, `TRUNCATE`
  - Result limit: 50 rows maximum
  - Read-only connection to `dbt_dev` schema

**Environment Requirements:**

| Variable | Description |
|----------|-------------|
| `DATABASE_URL` | Postgres connection string |
| `GOOGLE_GENERATIVE_AI_API_KEY` | API key for Gemini |
